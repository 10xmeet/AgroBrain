{% extends 'myapp/base.html' %}

{% block title %}Market Trends{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<section class="bg-gradient-to-r from-emerald-600 to-emerald-800 py-14 text-center">
    <h1 class="text-5xl font-extrabold text-gray-900 drop-shadow-lg">
        üåæ <span class="bg-white/30 px-6 py-4 rounded-lg">Live Market Prices</span> üåø
    </h1>
    <p class="text-white mt-4 text-xl">Real-time agricultural commodity prices with trend analysis</p>
</section>

<main class="bg-emerald-50 py-12">
    <div class="container mx-auto px-6 sm:px-8 lg:px-10">
        <!-- Market Statistics Dashboard -->
        {% if market_stats %}
        <div class="mb-10 bg-white p-6 rounded-xl shadow-xl">
            <h2 class="text-2xl font-bold text-emerald-800 mb-4">Market Price Dashboard</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Price Statistics -->
                <div class="bg-emerald-50 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold text-emerald-700 mb-3">Price Statistics by Commodity</h3>
                    <div class="overflow-x-auto overflow-y-auto h-100"><!-- Added fixed height and vertical scroll -->
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-emerald-600 text-white">
                                <tr>
                                    <th class="p-3 text-left">Commodity</th>
                                    <th class="p-3 text-left">Avg Price (‚Çπ)</th>
                                    <th class="p-3 text-left">Min Price (‚Çπ)</th>
                                    <th class="p-3 text-left">Max Price (‚Çπ)</th>
                                    <th class="p-3 text-left">Markets</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-300">
                                {% for commodity, stats in market_stats.items %}
                                <tr class="hover:bg-emerald-100 transition-all">
                                    <td class="p-3 border font-medium">{{ commodity }}</td>
                                    <td class="p-3 border font-bold">‚Çπ{{ stats.avg_price }}</td>
                                    <td class="p-3 border text-green-600">‚Çπ{{ stats.min_price }}</td>
                                    <td class="p-3 border text-red-600">‚Çπ{{ stats.max_price }}</td>
                                    <td class="p-3 border">{{ stats.count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Price Chart -->
                <div class="bg-emerald-50 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold text-emerald-700 mb-3">Price Comparison</h3>
                    <canvas id="priceChart" width="400" height="300"></canvas>
                </div>
                
                <!-- Chart.js Script for Price Chart -->
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Check if we have market stats data to display
                        {% if market_stats %}
                            const ctx = document.getElementById('priceChart').getContext('2d');
                            
                            // Extract data for chart
                            const commodities = [];
                            const avgPrices = [];
                            const minPrices = [];
                            const maxPrices = [];
                            
                            {% for commodity, stats in market_stats.items %}
                                // Limit to top 5 commodities for readability
                                if (commodities.length < 5) {
                                    commodities.push("{{ commodity }}");
                                    avgPrices.push({{ stats.avg_price }});
                                    minPrices.push({{ stats.min_price }});
                                    maxPrices.push({{ stats.max_price }});
                                }
                            {% endfor %}
                            
                            // Create chart
                            const myChart = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: commodities,
                                    datasets: [
                                        {
                                            label: 'Avg Price (‚Çπ)',
                                            data: avgPrices,
                                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                            borderColor: 'rgba(16, 185, 129, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Min Price (‚Çπ)',
                                            data: minPrices,
                                            backgroundColor: 'rgba(52, 211, 153, 0.5)',
                                            borderColor: 'rgba(52, 211, 153, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Max Price (‚Çπ)',
                                            data: maxPrices,
                                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                                            borderColor: 'rgba(239, 68, 68, 1)',
                                            borderWidth: 1
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Price (‚Çπ)'
                                            }
                                        },
                                        x: {
                                            title: {
                                                display: true,
                                                text: 'Commodity'
                                            }
                                        }
                                    },
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Commodity Price Comparison',
                                            font: {
                                                size: 16
                                            }
                                        },
                                        legend: {
                                            position: 'bottom'
                                        }
                                    }
                                }
                            });
                        {% endif %}
                    });
                </script>
            </div>
        </div>
        {% endif %}
        
        <!-- üîç Advanced Search Form -->
        <form method="get" action="{% url 'market' %}" class="mb-10 bg-white p-8 rounded-xl shadow-xl">
            <h2 class="text-2xl font-bold text-emerald-800 mb-4">Advanced Search</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="search_query" class="block text-gray-700 font-semibold mb-2">üîç Commodity</label>
                    <select name="search_query" id="search_query" 
                        class="w-full px-5 py-3 border-2 border-emerald-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        <option value="">All Commodities</option>
                        {% for commodity in commodities %}
                            <option value="{{ commodity }}" {% if search_query == commodity.lower %}selected{% endif %}>{{ commodity }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="search_state" class="block text-gray-700 font-semibold mb-2">üìç State</label>
                    <select name="search_state" id="search_state" 
                        class="w-full px-5 py-3 border-2 border-emerald-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        <option value="">All States</option>
                        {% for state in states %}
                            <option value="{{ state }}" {% if search_state == state.lower %}selected{% endif %}>{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="search_district" class="block text-gray-700 font-semibold mb-2">üèôÔ∏è District</label>
                    <select name="search_district" id="search_district" 
                        class="w-full px-5 py-3 border-2 border-emerald-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        <option value="">All Districts</option>
                        {% for district in districts %}
                            <option value="{{ district }}" {% if search_district == district.lower %}selected{% endif %}>{{ district }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="price_filter" class="block text-gray-700 font-semibold mb-2">üí∞ Price Range (‚Çπ)</label>
                    <select name="price_filter" id="price_filter" 
                        class="w-full px-5 py-3 border-2 border-emerald-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        <option value="">All Prices</option>
                        <option value="0-500" {% if price_filter == '0-500' %}selected{% endif %}>‚Çπ0 - ‚Çπ500</option>
                        <option value="500-1000" {% if price_filter == '500-1000' %}selected{% endif %}>‚Çπ500 - ‚Çπ1,000</option>
                        <option value="1000-2000" {% if price_filter == '1000-2000' %}selected{% endif %}>‚Çπ1,000 - ‚Çπ2,000</option>
                        <option value="2000-5000" {% if price_filter == '2000-5000' %}selected{% endif %}>‚Çπ2,000 - ‚Çπ5,000</option>
                        <option value="5000-10000" {% if price_filter == '5000-10000' %}selected{% endif %}>‚Çπ5,000 - ‚Çπ10,000</option>
                        <option value="10000-100000" {% if price_filter == '10000-100000' %}selected{% endif %}>‚Çπ10,000+</option>
                    </select>
                </div>
                
                <div>
                    <label for="sort_by" class="block text-gray-700 font-semibold mb-2">üîÑ Sort By</label>
                    <select name="sort_by" id="sort_by" 
                        class="w-full px-5 py-3 border-2 border-emerald-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        <option value="Modal_Price" {% if sort_by == 'Modal_Price' %}selected{% endif %}>Modal Price</option>
                        <option value="Min_Price" {% if sort_by == 'Min_Price' %}selected{% endif %}>Min Price</option>
                        <option value="Max_Price" {% if sort_by == 'Max_Price' %}selected{% endif %}>Max Price</option>
                        <option value="Commodity" {% if sort_by == 'Commodity' %}selected{% endif %}>Commodity</option>
                        <option value="State" {% if sort_by == 'State' %}selected{% endif %}>State</option>
                        <option value="District" {% if sort_by == 'District' %}selected{% endif %}>District</option>
                        <option value="Market" {% if sort_by == 'Market' %}selected{% endif %}>Market</option>
                    </select>
                </div>
                
                <div>
                    <label for="sort_order" class="block text-gray-700 font-semibold mb-2">üìä Sort Order</label>
                    <select name="sort_order" id="sort_order" 
                        class="w-full px-5 py-3 border-2 border-emerald-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Highest First</option>
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Lowest First</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-center">
                <button type="submit"
                    class="px-8 py-4 bg-emerald-600 text-white text-lg font-semibold rounded-lg hover:bg-emerald-700 transition-all shadow-lg">
                    üîé Search Markets
                </button>
            </div>
        </form>

        {% if error_message %}
        <p class="text-center text-red-500 font-medium text-lg mt-6 animate-bounce">
            {{ error_message }}
        </p>
        {% elif market_data and market_data.paginator.count > 0 %}
        
        <!-- üìä Market Data Table -->
        <div class="overflow-x-auto mt-6">
            <h2 class="text-2xl font-bold text-emerald-800 mb-4">Market Prices</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-emerald-600 text-white">
                        <tr>
                            <th class="p-3 text-left">Commodity</th>
                            <th class="p-3 text-left">Variety</th>
                            <th class="p-3 text-left">Market</th>
                            <th class="p-3 text-left">District</th>
                            <th class="p-3 text-left">State</th>
                            <th class="p-3 text-left">Arrival Date</th>
                            <th class="p-3 text-left">Min Price</th>
                            <th class="p-3 text-left">Max Price</th>
                            <th class="p-3 text-left">Modal Price</th>
                            <th class="p-3 text-left">Price Trend</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-300">
                        {% if market_data %}
                            {% for item in market_data %}
                            <tr class="hover:bg-emerald-100 transition-all even:bg-gray-100">
                                <td class="p-3 border font-medium">{{ item.commodity }}</td>
                                <td class="p-3 border">{{ item.variety|default:"Standard" }}</td>
                                <td class="p-3 border">{{ item.market }}</td>
                                <td class="p-3 border">{{ item.district }}</td>
                                <td class="p-3 border">{{ item.state }}</td>
                                <td class="p-3 border text-blue-600 font-semibold">{{ item.arrival_date }}</td>
                                <td class="p-3 border text-green-600 font-semibold">‚Çπ{{ item.min_price }}</td>
                                <td class="p-3 border text-red-600 font-semibold">‚Çπ{{ item.max_price }}</td>
                                <td class="p-3 border font-bold bg-emerald-100/60">‚Çπ{{ item.modal_price }}</td>
                                <td class="p-3 border">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">Market Price</span>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-red-500 font-semibold p-5">No Results Found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div class="flex justify-center mt-6 space-x-3">
            {% if market_data.has_previous %}
            <a href="{{ base_url }}{{ market_data.previous_page_number }}"
                class="px-6 py-3 bg-emerald-600 text-white text-lg rounded-lg hover:bg-emerald-700">
                ‚óÄ Previous
            </a>
            {% endif %}

            <span class="px-4 py-2 bg-gray-200 rounded-lg">
                Page {{ market_data.number }} of {{ market_data.paginator.num_pages }}
            </span>

            {% if market_data.has_next %}
            <a href="{{ base_url }}{{ market_data.next_page_number }}"
                class="px-6 py-3 bg-emerald-600 text-white text-lg rounded-lg hover:bg-emerald-700">
                Next ‚ñ∂
            </a>
            {% endif %}
        </div>

        {% else %}
        <p class="text-center text-gray-500">No results found. Try a different search.</p>
        {% endif %}
    </div>
</main>
{% endblock %}